---
title: "Model Comparison"
author: "Carson Slater"
date: '2022-10-26'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

```{r, include=TRUE}
# Loading packages
library(tidymodels)
library(tinytex)
library(stringr)
library(janitor)
library(glmnet)
library(lubridate)
library(knitr)
library(mosaic)
library(prophet)
```

```{r, eval=TRUE}
load("Data_Iteration2.Rdata")
```

# The Big Idea for this .Rmd

In my project, I have a forecasting model workflow with `Prophet`. The goal of this `.Rmd` is to create benchmark models and see how much better we can get Prophet to perform.

# Prepping the Data for the Modeling Process
```{r}
split <- by_day_filter %>% 
  rename(ds = placed_at, y = qty) %>% 
  group_by(sku_id) %>% 
  group_split()
```


I found that SKU's #757 (`split[[253}}`), #983 (`split[[293]]`), #1487 (`split[[356]]`), have either 338 or 339 observations, so these SKU's will be good to compare the time series modeling process on.

```{r}
# Building a Benchmark `Prophet` Model
# Preprocessing
df <-  split[[253]] 

# Creating an evaluation data frame
eval <- df %>% 
  filter(ds >= max(df$ds) - weeks(8)) %>% 
  complete(ds = seq.Date(min(ds), max(ds), by="day")) %>% 
  mutate(y = ifelse(is.na(y), 0, y))
  
eval <- eval %>% slice(1:(n() - 1))

orig_df <- df

df <- df %>% filter(ds < max(df$ds) - weeks(8))
```

```{r}
mod <- prophet(df, 
               yearly.seasonality = TRUE, 
               fit = FALSE, 
               interval.width = 0.7) %>% 
  add_country_holidays(country_name = 'ID')

fit <- fit.prophet(mod, df)

# 6 Months
future <- make_future_dataframe(fit, periods = 8*7)

# Make a forecast
fcst <- predict(fit, future)

##########################################################
# Since we cannot have negative predictive quantities, 
# I invert the upper confidence interval and set the 
# negative yhats to zero
##########################################################

fcst <- fcst %>% mutate(diff = yhat_upper - yhat)

fcst <- fcst %>%
  mutate(yhat_upper = ifelse(yhat_upper >= 0, yhat_upper, diff)) %>% 
  mutate(yhat = ifelse(yhat >= 0, yhat, 0), 
         yhat_lower = ifelse(yhat_lower >= 0, yhat_lower, 0))

# Final plot of forecast
plot(fit, fcst) + 
  add_changepoints_to_plot(m = fit, cp_color = "orange") +
  labs(title = "Fitted Model and Forecast of an SKU",
       x = "Date",
       y = "Volume Purchased") +
  theme_minimal()
```


